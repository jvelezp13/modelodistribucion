{% extends "admin/base.html" %}
{% load humanize %}

{% block title %}Distribución de Ventas{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .distribucion-container {
        padding: 20px;
    }
    .filtros-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 20px;
        align-items: end;
    }
    .filtros-form .field {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filtros-form label {
        font-weight: bold;
        font-size: 13px;
        color: #666;
    }
    .filtros-form select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        min-width: 200px;
        font-size: 14px;
    }
    .filtros-form button {
        padding: 8px 20px;
        background: #417690;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .filtros-form button:hover {
        background: #205067;
    }

    .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid #ddd;
    }
    .tab {
        padding: 12px 24px;
        background: #f0f0f0;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: #666;
        border-radius: 8px 8px 0 0;
        margin-right: 4px;
        transition: all 0.2s;
    }
    .tab:hover {
        background: #e0e0e0;
    }
    .tab.active {
        background: #417690;
        color: white;
    }

    .tab-content {
        display: none;
        padding: 20px;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
    }
    .tab-content.active {
        display: block;
    }

    .tabla-distribucion {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .tabla-distribucion th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-size: 13px;
        color: #333;
        border-bottom: 2px solid #ddd;
    }
    .tabla-distribucion td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }
    .tabla-distribucion tr:hover {
        background: #f9f9f9;
    }
    .tabla-distribucion input[type="number"] {
        width: 150px;
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        text-align: right;
    }
    .tabla-distribucion input[type="number"]:focus {
        outline: none;
        border-color: #417690;
        box-shadow: 0 0 0 2px rgba(65, 118, 144, 0.2);
    }

    .participacion {
        font-weight: bold;
        color: #417690;
    }

    .totales-row {
        background: #e8f4f8 !important;
        font-weight: bold;
    }
    .totales-row td {
        border-top: 2px solid #417690;
        padding: 15px 12px;
    }

    .total-box {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 16px;
    }
    .total-box.ok {
        background: #d4edda;
        color: #155724;
    }
    .total-box.warning {
        background: #fff3cd;
        color: #856404;
    }

    .btn-guardar {
        margin-top: 20px;
        padding: 12px 30px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-guardar:hover {
        background: #218838;
    }
    .btn-guardar:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .mensaje {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .mensaje.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .mensaje.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
    }

    .zona-header {
        background: #f0f7fa !important;
        font-weight: bold;
    }
    .zona-header td {
        color: #417690;
        padding-top: 15px;
    }

    .btn-agregar {
        padding: 10px 20px;
        background: #417690;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 15px;
    }
    .btn-agregar:hover {
        background: #205067;
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.active {
        display: flex;
    }
    .modal {
        background: white;
        border-radius: 8px;
        width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h3 {
        margin: 0;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
    }
    .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }
    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .modal-footer button {
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .modal-footer .btn-cancelar {
        background: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
    }
    .modal-footer .btn-confirmar {
        background: #28a745;
        border: none;
        color: white;
    }

    .municipios-lista {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .municipio-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .municipio-item:last-child {
        border-bottom: none;
    }
    .municipio-item:hover {
        background: #f9f9f9;
    }
    .municipio-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
    .municipio-depto {
        color: #666;
        font-size: 12px;
    }
    .buscar-municipio {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 14px;
    }
    .seleccionar-todos {
        padding: 10px 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="distribucion-container">
    <h1>Distribución de Ventas Proyectadas</h1>

    <div id="mensaje-container"></div>

    <!-- Filtros -->
    <form class="filtros-form" method="get">
        <div class="field">
            <label for="marca">Marca:</label>
            <select name="marca" id="marca" required>
                <option value="">-- Seleccionar --</option>
                {% for marca in marcas %}
                <option value="{{ marca.id }}" {% if marca_seleccionada and marca.id == marca_seleccionada.id %}selected{% endif %}>
                    {{ marca.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="field">
            <label for="escenario">Escenario:</label>
            <select name="escenario" id="escenario" required>
                <option value="">-- Seleccionar --</option>
                {% for esc in escenarios %}
                <option value="{{ esc.id }}" {% if escenario_seleccionado and esc.id == escenario_seleccionado.id %}selected{% endif %}>
                    {{ esc.nombre }} ({{ esc.anio }})
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">Cargar</button>
    </form>

    {% if marca_seleccionada and escenario_seleccionado %}
    <!-- Tabs -->
    <div class="tabs">
        <button type="button" class="tab active" data-tab="zonas">
            Zonas ({{ zonas|length }})
        </button>
        <button type="button" class="tab" data-tab="municipios">
            Municipios ({{ municipios|length }})
        </button>
    </div>

    <!-- Tab Zonas -->
    <div id="tab-zonas" class="tab-content active">
        {% if zonas %}
        <table class="tabla-distribucion" id="tabla-zonas">
            <thead>
                <tr>
                    <th style="width: 40%">Zona</th>
                    <th style="width: 30%">Venta Proyectada</th>
                    <th style="width: 30%">Participación %</th>
                </tr>
            </thead>
            <tbody>
                {% for zona in zonas %}
                <tr data-id="{{ zona.id }}">
                    <td>{{ zona.nombre }}</td>
                    <td>
                        <input type="number"
                               class="venta-input"
                               data-tipo="zona"
                               data-id="{{ zona.id }}"
                               value="{{ zona.venta_proyectada|floatformat:0 }}"
                               min="0"
                               step="1000">
                    </td>
                    <td class="participacion">
                        <span class="participacion-valor">{{ zona.participacion_ventas|floatformat:2 }}</span>%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totales-row">
                    <td><strong>TOTAL</strong></td>
                    <td>
                        <span class="total-box" id="total-zonas-box">
                            $<span id="total-zonas">{{ total_venta_zonas|floatformat:0|intcomma }}</span>
                        </span>
                    </td>
                    <td class="participacion">
                        <span id="total-participacion-zonas">100.00</span>%
                    </td>
                </tr>
            </tfoot>
        </table>
        <button type="button" class="btn-guardar" id="guardar-zonas">
            Guardar Distribución de Zonas
        </button>
        {% else %}
        <div class="empty-state">
            <h3>No hay zonas configuradas</h3>
            <p>Primero debes crear zonas comerciales para esta marca y escenario.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab Municipios -->
    <div id="tab-municipios" class="tab-content">
        {% if municipios_disponibles %}
        <button type="button" class="btn-agregar" id="btn-agregar-municipios">
            + Agregar Municipios
        </button>
        {% endif %}

        {% if municipios %}
        <table class="tabla-distribucion" id="tabla-municipios">
            <thead>
                <tr>
                    <th style="width: 20%">Departamento</th>
                    <th style="width: 30%">Municipio</th>
                    <th style="width: 25%">Venta Proyectada</th>
                    <th style="width: 25%">Participación %</th>
                </tr>
            </thead>
            <tbody>
                {% for vm in municipios %}
                <tr data-id="{{ vm.id }}">
                    <td>{{ vm.municipio.departamento }}</td>
                    <td>{{ vm.municipio.nombre }}</td>
                    <td>
                        <input type="number"
                               class="venta-input"
                               data-tipo="municipio"
                               data-id="{{ vm.id }}"
                               value="{{ vm.venta_proyectada|floatformat:0 }}"
                               min="0"
                               step="1000">
                    </td>
                    <td class="participacion">
                        <span class="participacion-valor">{{ vm.participacion_ventas|floatformat:2 }}</span>%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totales-row">
                    <td colspan="2"><strong>TOTAL</strong></td>
                    <td>
                        <span class="total-box" id="total-municipios-box">
                            $<span id="total-municipios">{{ total_venta_municipios|floatformat:0|intcomma }}</span>
                        </span>
                    </td>
                    <td class="participacion">
                        <span id="total-participacion-municipios">100.00</span>%
                    </td>
                </tr>
            </tfoot>
        </table>
        <button type="button" class="btn-guardar" id="guardar-municipios">
            Guardar Distribución de Municipios
        </button>
        {% else %}
        <div class="empty-state">
            <h3>No hay municipios configurados</h3>
            <p>Agrega municipios para distribuir las ventas geográficamente.</p>
            {% if municipios_disponibles %}
            <button type="button" class="btn-agregar" id="btn-agregar-municipios-empty" style="margin-top: 15px;">
                + Agregar Municipios
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Modal Agregar Municipios -->
    {% if municipios_disponibles %}
    <div class="modal-overlay" id="modal-municipios">
        <div class="modal">
            <div class="modal-header">
                <h3>Agregar Municipios</h3>
                <button type="button" class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="buscar-municipio" id="buscar-municipio" placeholder="Buscar municipio...">
                <div class="seleccionar-todos">
                    <label>
                        <input type="checkbox" id="seleccionar-todos"> Seleccionar todos
                    </label>
                </div>
                <div class="municipios-lista" id="municipios-lista">
                    {% regroup municipios_disponibles by departamento as municipios_por_depto %}
                    {% for depto in municipios_por_depto %}
                    {% for mun in depto.list %}
                    <div class="municipio-item" data-nombre="{{ mun.nombre|lower }}" data-depto="{{ mun.departamento|lower }}">
                        <input type="checkbox" name="municipio" value="{{ mun.id }}">
                        <span>{{ mun.nombre }}</span>
                        <span class="municipio-depto">{{ mun.departamento }}</span>
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar" id="modal-cancelar">Cancelar</button>
                <button type="button" class="btn-confirmar" id="modal-confirmar">Agregar Seleccionados</button>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <h3>Selecciona una marca y escenario</h3>
        <p>Para ver y editar la distribución de ventas, primero selecciona una marca y un escenario activo.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
(function() {
    // Manejo de tabs
    document.querySelectorAll('.tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            // Desactivar todos los tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Activar el tab clickeado
            this.classList.add('active');
            document.getElementById('tab-' + this.dataset.tab).classList.add('active');
        });
    });

    // Recalcular participaciones al cambiar valores
    function recalcularParticipaciones(tipo) {
        const tabla = document.getElementById('tabla-' + tipo);
        if (!tabla) return;

        const inputs = tabla.querySelectorAll('.venta-input');
        let total = 0;

        inputs.forEach(function(input) {
            total += parseFloat(input.value) || 0;
        });

        // Actualizar participaciones
        inputs.forEach(function(input) {
            const valor = parseFloat(input.value) || 0;
            const participacion = total > 0 ? (valor / total * 100) : 0;
            const row = input.closest('tr');
            const partSpan = row.querySelector('.participacion-valor');
            if (partSpan) {
                partSpan.textContent = participacion.toFixed(2);
            }
        });

        // Actualizar total
        const totalSpan = document.getElementById('total-' + tipo);
        if (totalSpan) {
            totalSpan.textContent = total.toLocaleString('es-CO', {maximumFractionDigits: 0});
        }

        // Actualizar participación total
        const totalPartSpan = document.getElementById('total-participacion-' + tipo);
        if (totalPartSpan) {
            totalPartSpan.textContent = total > 0 ? '100.00' : '0.00';
        }
    }

    // Event listeners para inputs
    document.querySelectorAll('.venta-input').forEach(function(input) {
        input.addEventListener('input', function() {
            const tipo = this.dataset.tipo === 'zona' ? 'zonas' : 'municipios';
            recalcularParticipaciones(tipo);
        });
    });

    // Función para mostrar mensajes
    function mostrarMensaje(texto, tipo) {
        const container = document.getElementById('mensaje-container');
        container.innerHTML = '<div class="mensaje ' + tipo + '">' + texto + '</div>';
        setTimeout(function() {
            container.innerHTML = '';
        }, 5000);
    }

    // Guardar zonas
    const btnGuardarZonas = document.getElementById('guardar-zonas');
    if (btnGuardarZonas) {
        btnGuardarZonas.addEventListener('click', function() {
            const items = [];
            document.querySelectorAll('#tabla-zonas .venta-input').forEach(function(input) {
                items.push({
                    id: parseInt(input.dataset.id),
                    venta: parseFloat(input.value) || 0
                });
            });

            this.disabled = true;
            this.textContent = 'Guardando...';

            fetch('{% url "admin:guardar_distribucion_ventas" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    tipo: 'zonas',
                    items: items
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje('Distribución de zonas guardada correctamente.', 'success');
                } else {
                    mostrarMensaje('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                mostrarMensaje('Error al guardar: ' + error, 'error');
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'Guardar Distribución de Zonas';
            });
        });
    }

    // Guardar municipios
    const btnGuardarMunicipios = document.getElementById('guardar-municipios');
    if (btnGuardarMunicipios) {
        btnGuardarMunicipios.addEventListener('click', function() {
            const items = [];
            document.querySelectorAll('#tabla-municipios .venta-input').forEach(function(input) {
                items.push({
                    id: parseInt(input.dataset.id),
                    venta: parseFloat(input.value) || 0
                });
            });

            this.disabled = true;
            this.textContent = 'Guardando...';

            fetch('{% url "admin:guardar_distribucion_ventas" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    tipo: 'municipios',
                    items: items
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje('Distribución de municipios guardada correctamente.', 'success');
                } else {
                    mostrarMensaje('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                mostrarMensaje('Error al guardar: ' + error, 'error');
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = 'Guardar Distribución de Municipios';
            });
        });
    }

    // Calcular participaciones iniciales
    recalcularParticipaciones('zonas');
    recalcularParticipaciones('municipios');

    // ========== MODAL AGREGAR MUNICIPIOS ==========
    const modal = document.getElementById('modal-municipios');
    const btnAgregar = document.getElementById('btn-agregar-municipios');
    const btnAgregarEmpty = document.getElementById('btn-agregar-municipios-empty');
    const btnClose = document.getElementById('modal-close');
    const btnCancelar = document.getElementById('modal-cancelar');
    const btnConfirmar = document.getElementById('modal-confirmar');
    const buscarInput = document.getElementById('buscar-municipio');
    const selectTodos = document.getElementById('seleccionar-todos');

    function abrirModal() {
        if (modal) modal.classList.add('active');
    }

    function cerrarModal() {
        if (modal) {
            modal.classList.remove('active');
            // Limpiar selección
            document.querySelectorAll('#municipios-lista input[type="checkbox"]').forEach(function(cb) {
                cb.checked = false;
            });
            if (buscarInput) buscarInput.value = '';
            if (selectTodos) selectTodos.checked = false;
            filtrarMunicipios('');
        }
    }

    if (btnAgregar) btnAgregar.addEventListener('click', abrirModal);
    if (btnAgregarEmpty) btnAgregarEmpty.addEventListener('click', abrirModal);
    if (btnClose) btnClose.addEventListener('click', cerrarModal);
    if (btnCancelar) btnCancelar.addEventListener('click', cerrarModal);

    // Cerrar al hacer clic fuera del modal
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) cerrarModal();
        });
    }

    // Filtrar municipios
    function filtrarMunicipios(texto) {
        const items = document.querySelectorAll('.municipio-item');
        texto = texto.toLowerCase();
        items.forEach(function(item) {
            const nombre = item.dataset.nombre || '';
            const depto = item.dataset.depto || '';
            if (nombre.includes(texto) || depto.includes(texto)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    if (buscarInput) {
        buscarInput.addEventListener('input', function() {
            filtrarMunicipios(this.value);
        });
    }

    // Seleccionar todos
    if (selectTodos) {
        selectTodos.addEventListener('change', function() {
            const checked = this.checked;
            document.querySelectorAll('.municipio-item').forEach(function(item) {
                if (item.style.display !== 'none') {
                    item.querySelector('input[type="checkbox"]').checked = checked;
                }
            });
        });
    }

    // Confirmar agregar municipios
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', function() {
            const seleccionados = [];
            document.querySelectorAll('#municipios-lista input[type="checkbox"]:checked').forEach(function(cb) {
                seleccionados.push(parseInt(cb.value));
            });

            if (seleccionados.length === 0) {
                alert('Selecciona al menos un municipio');
                return;
            }

            this.disabled = true;
            this.textContent = 'Agregando...';

            fetch('{% url "admin:agregar_municipios_venta" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    marca_id: {{ marca_seleccionada.id|default:"null" }},
                    escenario_id: {{ escenario_seleccionado.id|default:"null" }},
                    municipio_ids: seleccionados
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje('Se agregaron ' + data.creados + ' municipio(s).', 'success');
                    // Recargar la página para ver los nuevos municipios
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                } else {
                    mostrarMensaje('Error: ' + data.error, 'error');
                    this.disabled = false;
                    this.textContent = 'Agregar Seleccionados';
                }
            })
            .catch(error => {
                mostrarMensaje('Error al agregar: ' + error, 'error');
                this.disabled = false;
                this.textContent = 'Agregar Seleccionados';
            });
        });
    }
})();
</script>
{% endblock %}
