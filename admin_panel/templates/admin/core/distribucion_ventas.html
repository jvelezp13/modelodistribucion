{% extends "admin/base_site.html" %}
{% load humanize l10n %}

{% block title %}Distribución de Ventas{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Variables heredadas del tema */
    :root {
        --lf-primary: #166534;
        --lf-primary-dark: #14532D;
        --lf-primary-light: #059669;
        --lf-bg-light: #e8f5e9;
    }
    .distribucion-container {
        padding: 20px;
    }
    .filtros-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 20px;
        align-items: end;
        flex-wrap: wrap;
    }
    .filtros-form .field {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filtros-form label {
        font-weight: bold;
        font-size: 13px;
        color: #666;
    }
    .filtros-form select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        min-width: 200px;
        font-size: 14px;
    }
    .filtros-form button {
        padding: 8px 20px;
        background: var(--lf-primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .filtros-form button:hover {
        background: var(--lf-primary-dark);
    }

    /* Info box para contexto */
    .info-box {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: flex;
        gap: 30px;
        align-items: center;
        flex-wrap: wrap;
    }
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .info-item .label {
        font-size: 11px;
        color: #1565c0;
        text-transform: uppercase;
        font-weight: 600;
    }
    .info-item .value {
        font-size: 18px;
        font-weight: bold;
        color: #0d47a1;
    }

    .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid #ddd;
    }
    .tab {
        padding: 12px 24px;
        background: #f0f0f0;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: #666;
        border-radius: 8px 8px 0 0;
        margin-right: 4px;
        transition: all 0.2s;
    }
    .tab:hover {
        background: #e0e0e0;
    }
    .tab.active {
        background: var(--lf-primary);
        color: white;
    }

    .tab-content {
        display: none;
        padding: 20px;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
    }
    .tab-content.active {
        display: block;
    }

    .tabla-distribucion {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .tabla-distribucion th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-size: 13px;
        color: #333;
        border-bottom: 2px solid #ddd;
    }
    .tabla-distribucion td {
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }
    .tabla-distribucion tr:hover {
        background: #f9f9f9;
    }
    .tabla-distribucion input[type="number"] {
        width: 100px;
        padding: 6px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        text-align: right;
    }
    .tabla-distribucion input[type="number"]:focus {
        outline: none;
        border-color: var(--lf-primary);
        box-shadow: 0 0 0 2px rgba(22, 101, 52, 0.2);
    }

    .venta-calculada {
        font-weight: bold;
        color: #1565c0;
        font-size: 14px;
    }

    .totales-row {
        background: var(--lf-bg-light) !important;
        font-weight: bold;
    }
    .totales-row td {
        border-top: 2px solid var(--lf-primary);
        padding: 15px 12px;
    }

    .total-box {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
    }
    .total-box.ok {
        background: #d4edda;
        color: #155724;
    }
    .total-box.warning {
        background: #fff3cd;
        color: #856404;
    }
    .total-box.error {
        background: #f8d7da;
        color: #721c24;
    }

    .btn-guardar {
        margin-top: 20px;
        padding: 12px 30px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-guardar:hover {
        background: #218838;
    }
    .btn-guardar:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .mensaje {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .mensaje.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .mensaje.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
    }

    .zona-header-card {
        background: var(--lf-primary);
        color: white;
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .operacion-tag {
        display: inline-block;
        padding: 2px 8px;
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
        font-size: 11px;
        margin-left: 10px;
    }

    .help-text {
        font-size: 12px;
        color: #666;
        margin-bottom: 15px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 4px;
        border-left: 3px solid var(--lf-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="distribucion-container">
    <h1>Distribucion de Ventas por Participacion</h1>

    <div id="mensaje-container"></div>

    <!-- Filtros -->
    <form class="filtros-form" method="get">
        <div class="field">
            <label for="marca">Marca:</label>
            <select name="marca" id="marca" required>
                <option value="">-- Seleccionar --</option>
                {% for marca in marcas %}
                <option value="{{ marca.id }}" {% if marca_seleccionada and marca.id == marca_seleccionada.id %}selected{% endif %}>
                    {{ marca.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="field">
            <label for="escenario">Escenario:</label>
            <select name="escenario" id="escenario" required>
                <option value="">-- Seleccionar --</option>
                {% for esc in escenarios %}
                <option value="{{ esc.id }}" {% if escenario_seleccionado and esc.id == escenario_seleccionado.id %}selected{% endif %}>
                    {{ esc.nombre }} ({{ esc.anio }})
                </option>
                {% endfor %}
            </select>
        </div>
        {% if operaciones %}
        <div class="field">
            <label for="operacion">Operacion (opcional):</label>
            <select name="operacion" id="operacion">
                <option value="">-- Todas --</option>
                {% for op in operaciones %}
                <option value="{{ op.id }}" {% if operacion_seleccionada and op.id == operacion_seleccionada.id %}selected{% endif %}>
                    {{ op.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <button type="submit">Cargar</button>
    </form>

    {% if marca_seleccionada and escenario_seleccionado %}

    <!-- Info Box con contexto de ventas -->
    <div class="info-box">
        <div class="info-item">
            <span class="label">Venta Mensual Total (Marca)</span>
            <span class="value">${{ venta_total_marca|floatformat:0|intcomma }}</span>
        </div>
        {% if marcas_operacion %}
        <div class="info-item">
            <span class="label">Operaciones Configuradas</span>
            <span class="value">{{ marcas_operacion|length }}</span>
        </div>
        {% endif %}
        <div class="info-item">
            <span class="label">Zonas</span>
            <span class="value">{{ zonas|length }}</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button type="button" class="tab active" data-tab="operaciones">
            Operaciones ({{ marcas_operacion|length }})
        </button>
        <button type="button" class="tab" data-tab="zonas">
            Zonas ({{ zonas|length }})
        </button>
        <button type="button" class="tab" data-tab="zonas-municipios">
            Zona - Municipio
        </button>
    </div>

    <!-- Tab Operaciones -->
    <div id="tab-operaciones" class="tab-content active">
        <div class="help-text">
            Configure el porcentaje de participacion de cada operacion. La suma debe ser 100%.
            La venta se calcula automaticamente: Venta Total Marca x Participacion%.
        </div>

        {% if marcas_operacion %}
        <table class="tabla-distribucion" id="tabla-operaciones">
            <thead>
                <tr>
                    <th style="width: 35%">Operacion</th>
                    <th style="width: 15%">Tasa ICA</th>
                    <th style="width: 20%">Participacion %</th>
                    <th style="width: 30%">Venta Calculada</th>
                </tr>
            </thead>
            <tbody>
                {% for mo in marcas_operacion %}
                <tr data-id="{{ mo.id }}">
                    <td>
                        <strong>{{ mo.operacion.nombre }}</strong>
                        <span style="color: #999; font-size: 12px; margin-left: 5px;">({{ mo.operacion.codigo }})</span>
                    </td>
                    <td>{{ mo.operacion.tasa_ica }}%</td>
                    <td>
                        <input type="number"
                               class="participacion-input"
                               data-tipo="operacion"
                               data-id="{{ mo.id }}"
                               data-operacion-id="{{ mo.operacion.id }}"
                               value="{{ mo.participacion_ventas|unlocalize }}"
                               min="0"
                               max="100"
                               step="0.01">
                        %
                    </td>
                    <td class="venta-calculada">
                        $<span class="venta-valor">{{ mo.venta_proyectada|floatformat:0|intcomma }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totales-row">
                    <td colspan="2"><strong>TOTAL</strong></td>
                    <td>
                        <span class="total-box" id="total-operaciones-box">
                            <span id="total-participacion-operaciones">{{ total_participacion_operaciones|floatformat:2 }}</span>%
                        </span>
                    </td>
                    <td class="venta-calculada">
                        $<span id="total-venta-operaciones">0</span>
                    </td>
                </tr>
            </tfoot>
        </table>
        <button type="button" class="btn-guardar" id="guardar-operaciones">
            Guardar Distribucion por Operaciones
        </button>
        {% else %}
        <div class="empty-state">
            <h3>No hay operaciones configuradas</h3>
            <p>Primero debes crear operaciones y asociarlas a esta marca desde el admin.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab Zonas -->
    <div id="tab-zonas" class="tab-content">
        <div class="help-text">
            Configure el porcentaje de participacion de cada zona dentro de su operacion.
            La suma de zonas por operacion debe ser 100%.
        </div>

        {% if zonas %}
        <table class="tabla-distribucion" id="tabla-zonas">
            <thead>
                <tr>
                    <th style="width: 30%">Zona</th>
                    <th style="width: 20%">Operacion</th>
                    <th style="width: 20%">Participacion %</th>
                    <th style="width: 30%">Venta Calculada</th>
                </tr>
            </thead>
            <tbody>
                {% for zona in zonas %}
                <tr data-id="{{ zona.id }}" data-operacion="{{ zona.operacion.id|default:'' }}">
                    <td><strong>{{ zona.nombre }}</strong></td>
                    <td>
                        {% if zona.operacion %}
                        <span class="operacion-tag" style="background: {{ zona.operacion.color }}20; color: {{ zona.operacion.color }}; border: 1px solid {{ zona.operacion.color }};">
                            {{ zona.operacion.nombre }}
                        </span>
                        {% else %}
                        <span style="color: #999;">Sin operacion</span>
                        {% endif %}
                    </td>
                    <td>
                        <input type="number"
                               class="participacion-input"
                               data-tipo="zona"
                               data-id="{{ zona.id }}"
                               data-operacion="{{ zona.operacion.id|default:'' }}"
                               value="{{ zona.participacion_ventas|unlocalize }}"
                               min="0"
                               max="100"
                               step="0.01">
                        %
                    </td>
                    <td class="venta-calculada">
                        $<span class="venta-valor">{{ zona.venta_proyectada|floatformat:0|intcomma }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="totales-row">
                    <td colspan="2"><strong>TOTAL</strong></td>
                    <td>
                        <span class="total-box" id="total-zonas-box">
                            <span id="total-participacion-zonas">{{ total_participacion_zonas|floatformat:2 }}</span>%
                        </span>
                    </td>
                    <td class="venta-calculada">
                        $<span id="total-venta-zonas">{{ total_venta_zonas|floatformat:0|intcomma }}</span>
                    </td>
                </tr>
            </tfoot>
        </table>
        <!-- Indicadores de validacion por operacion -->
        <div id="validacion-zonas-por-operacion" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <strong style="font-size: 13px; color: #666;">Validación por Operación:</strong>
            <div id="validacion-operaciones-lista" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                <!-- Se llena dinámicamente -->
            </div>
        </div>

        <button type="button" class="btn-guardar" id="guardar-zonas">
            Guardar Distribucion de Zonas
        </button>
        {% else %}
        <div class="empty-state">
            <h3>No hay zonas configuradas</h3>
            <p>Primero debes crear zonas comerciales para esta marca y escenario.</p>
        </div>
        {% endif %}
    </div>

    <!-- Tab Zonas-Municipios -->
    <div id="tab-zonas-municipios" class="tab-content">
        <div class="help-text">
            Configure el porcentaje de participacion de cada municipio dentro de su zona.
            La suma de municipios por zona debe ser 100%.
        </div>

        {% if zonas_municipios %}
        {% for zona_data in zonas_municipios %}
        <div class="zona-municipios-card" style="margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <div class="zona-header-card">
                <div>
                    <strong>{{ zona_data.zona.nombre }}</strong>
                    {% if zona_data.zona.operacion %}
                    <span class="operacion-tag">{{ zona_data.zona.operacion.nombre }}</span>
                    {% endif %}
                    <span style="opacity: 0.8; margin-left: 10px; font-size: 12px;">
                        ({{ zona_data.municipios|length }} municipios)
                    </span>
                </div>
                <div style="font-size: 13px;">
                    Venta Zona: <strong>${{ zona_data.zona.venta_proyectada|floatformat:0|intcomma }}</strong>
                </div>
            </div>

            {% if zona_data.municipios %}
            <table class="tabla-distribucion" id="tabla-zona-{{ zona_data.zona.id }}" data-zona-id="{{ zona_data.zona.id }}" data-zona-venta="{{ zona_data.zona.venta_proyectada }}">
                <thead>
                    <tr>
                        <th style="width: 40%">Municipio</th>
                        <th style="width: 25%">Participacion %</th>
                        <th style="width: 35%">Venta Calculada</th>
                    </tr>
                </thead>
                <tbody>
                    {% for zm in zona_data.municipios %}
                    <tr data-id="{{ zm.id }}">
                        <td>{{ zm.municipio.nombre }} <span style="color: #999; font-size: 11px;">({{ zm.municipio.departamento }})</span></td>
                        <td>
                            <input type="number"
                                   class="participacion-input participacion-zona-mun"
                                   data-tipo="zona-municipio"
                                   data-id="{{ zm.id }}"
                                   data-zona-id="{{ zona_data.zona.id }}"
                                   value="{{ zm.participacion_ventas|unlocalize }}"
                                   min="0"
                                   max="100"
                                   step="0.01">
                            %
                        </td>
                        <td class="venta-calculada">
                            $<span class="venta-valor">{{ zm.venta_proyectada|floatformat:0|intcomma }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="totales-row">
                        <td><strong>TOTAL</strong></td>
                        <td>
                            <span class="total-box" id="total-participacion-zona-{{ zona_data.zona.id }}-box">
                                <span id="total-participacion-zona-{{ zona_data.zona.id }}">{{ zona_data.total_participacion|floatformat:2 }}</span>%
                            </span>
                        </td>
                        <td class="venta-calculada">
                            $<span id="total-venta-zona-{{ zona_data.zona.id }}">{{ zona_data.total_venta|floatformat:0|intcomma }}</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
            <div style="padding: 10px 15px; background: #f9f9f9; border-top: 1px solid #eee;">
                <button type="button" class="btn-guardar-zona" data-zona-id="{{ zona_data.zona.id }}" style="padding: 8px 20px; font-size: 13px;">
                    Guardar {{ zona_data.zona.nombre }}
                </button>
            </div>
            {% else %}
            <div style="padding: 30px; text-align: center; color: #666;">
                <p>No hay municipios asignados a esta zona.</p>
                <p style="font-size: 12px;">Agrega municipios desde el admin de Zonas.</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        <div style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
            <strong>Total General Zonas-Municipios:</strong>
            $<span id="total-general-zonas-municipios">{{ total_venta_zonas_municipios|floatformat:0|intcomma }}</span>
        </div>

        {% else %}
        <div class="empty-state">
            <h3>No hay zonas con municipios configurados</h3>
            <p>Primero debes crear zonas y asignarles municipios desde el admin de Zonas.</p>
        </div>
        {% endif %}
    </div>

    {% else %}
    <div class="empty-state">
        <h3>Selecciona una marca y escenario</h3>
        <p>Para ver y editar la distribucion de ventas, primero selecciona una marca y un escenario activo.</p>
    </div>
    {% endif %}
</div>

<!-- JavaScript inline para evitar conflictos con admin base -->
<script>
(function() {
    'use strict';

    // Esperar a que el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDistribucionVentas);
    } else {
        initDistribucionVentas();
    }

    function initDistribucionVentas() {
        // Usar |unlocalize para evitar problemas con formato de miles (50.000.000 -> 50000000)
        var ventaTotalStr = '{{ venta_total_marca|default:"0"|unlocalize }}';
        const VENTA_TOTAL_MARCA = parseFloat(ventaTotalStr) || 0;
        const CSRF_TOKEN = '{{ csrf_token }}';
        const GUARDAR_URL = '{% url "dxv_admin:guardar_distribucion_ventas" %}';

        // ========== MANEJO DE TABS ==========
        var tabs = document.querySelectorAll('.tab');
        var tabContents = document.querySelectorAll('.tab-content');

        for (var i = 0; i < tabs.length; i++) {
            (function(tab) {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Remover active de todos
                    for (var j = 0; j < tabs.length; j++) {
                        tabs[j].classList.remove('active');
                    }
                    for (var k = 0; k < tabContents.length; k++) {
                        tabContents[k].classList.remove('active');
                    }

                    // Activar el seleccionado
                    this.classList.add('active');
                    var tabId = 'tab-' + this.getAttribute('data-tab');
                    var content = document.getElementById(tabId);
                    if (content) {
                        content.classList.add('active');
                    }

                    return false;
                });
            })(tabs[i]);
        }

        // Formatear numero con separadores de miles
        function formatNumber(num) {
            return Math.round(num).toLocaleString('es-CO');
        }

        // Actualizar clase del total-box segun el porcentaje
        function updateTotalBoxClass(box, total) {
            if (!box) return;
            box.classList.remove('ok', 'warning', 'error');
            if (Math.abs(total - 100) < 0.01) {
                box.classList.add('ok');
            } else if (total > 100) {
                box.classList.add('error');
            } else {
                box.classList.add('warning');
            }
        }

        // Obtener mensaje de diferencia
        function getMensajeDiferencia(total) {
            var diff = 100 - total;
            if (Math.abs(diff) < 0.01) return '';
            if (diff > 0) return ' (faltan ' + diff.toFixed(2) + '%)';
            return ' (excede ' + Math.abs(diff).toFixed(2) + '%)';
        }

        // ========== OPERACIONES ==========
        function recalcularOperaciones() {
            var tabla = document.getElementById('tabla-operaciones');
            if (!tabla) return 0;

            var inputs = tabla.querySelectorAll('.participacion-input');
            var totalParticipacion = 0;
            var totalVenta = 0;

            inputs.forEach(function(input) {
                var participacion = parseFloat(input.value) || 0;
                var venta = VENTA_TOTAL_MARCA * (participacion / 100);
                totalParticipacion += participacion;
                totalVenta += venta;

                var row = input.closest('tr');
                var ventaSpan = row.querySelector('.venta-valor');
                if (ventaSpan) {
                    ventaSpan.textContent = formatNumber(venta);
                }
            });

            var totalPartSpan = document.getElementById('total-participacion-operaciones');
            if (totalPartSpan) totalPartSpan.textContent = totalParticipacion.toFixed(2);

            var totalVentaSpan = document.getElementById('total-venta-operaciones');
            if (totalVentaSpan) totalVentaSpan.textContent = formatNumber(totalVenta);

            var totalBox = document.getElementById('total-operaciones-box');
            updateTotalBoxClass(totalBox, totalParticipacion);

            // Actualizar estado del boton guardar
            var btnGuardar = document.getElementById('guardar-operaciones');
            if (btnGuardar) {
                var esValido = Math.abs(totalParticipacion - 100) < 0.01;
                btnGuardar.disabled = !esValido;
                btnGuardar.title = esValido ? '' : 'La suma debe ser exactamente 100%' + getMensajeDiferencia(totalParticipacion);
            }

            return totalParticipacion;
        }

        // ========== ZONAS ==========
        var operacionVentaMap = {};
        var operacionNombreMap = {};
        var tablaOp = document.getElementById('tabla-operaciones');
        if (tablaOp) {
            tablaOp.querySelectorAll('tbody tr').forEach(function(row) {
                var input = row.querySelector('.participacion-input');
                if (input && input.dataset.operacionId) {
                    operacionVentaMap[input.dataset.operacionId] = input;
                    // Obtener nombre de operacion de la celda de nombre
                    var nombreCell = row.querySelector('td:first-child strong');
                    if (nombreCell) {
                        operacionNombreMap[input.dataset.operacionId] = nombreCell.textContent.trim();
                    }
                }
            });
        }

        function recalcularZonasPorOperacion() {
            var tabla = document.getElementById('tabla-zonas');
            if (!tabla) return {};

            var inputs = tabla.querySelectorAll('.participacion-input');
            var totalesPorOperacion = {};
            var totalVentaGlobal = 0;
            var totalParticipacionGlobal = 0;

            for (var i = 0; i < inputs.length; i++) {
                var input = inputs[i];
                var participacion = parseFloat(input.value) || 0;
                var operacionId = input.dataset.operacion;
                var ventaOperacion = 0;

                totalParticipacionGlobal += participacion;

                if (operacionId && operacionVentaMap[operacionId]) {
                    var opParticipacion = parseFloat(operacionVentaMap[operacionId].value) || 0;
                    ventaOperacion = VENTA_TOTAL_MARCA * (opParticipacion / 100);
                }

                var venta = ventaOperacion * (participacion / 100);
                totalVentaGlobal += venta;

                // Acumular por operacion
                if (!totalesPorOperacion[operacionId]) {
                    totalesPorOperacion[operacionId] = { total: 0, venta: 0, nombre: operacionNombreMap[operacionId] || 'Sin operación' };
                }
                totalesPorOperacion[operacionId].total += participacion;
                totalesPorOperacion[operacionId].venta += venta;

                var row = input.closest('tr');
                var ventaSpan = row.querySelector('.venta-valor');
                if (ventaSpan) {
                    ventaSpan.textContent = formatNumber(venta);
                }
            }

            // Actualizar total de participacion global
            var totalPartSpan = document.getElementById('total-participacion-zonas');
            if (totalPartSpan) totalPartSpan.textContent = totalParticipacionGlobal.toFixed(2);

            // Actualizar total de venta
            var totalVentaSpan = document.getElementById('total-venta-zonas');
            if (totalVentaSpan) totalVentaSpan.textContent = formatNumber(totalVentaGlobal);

            // No aplicar clase de validacion al total global (no tiene sentido)
            var totalBox = document.getElementById('total-zonas-box');
            if (totalBox) {
                totalBox.classList.remove('ok', 'warning', 'error');
                totalBox.classList.add('warning'); // Siempre neutro
            }

            // Verificar si todas las operaciones suman 100% y mostrar indicadores
            var todasValidas = true;
            var listaValidacion = document.getElementById('validacion-operaciones-lista');
            if (listaValidacion) {
                var html = '';
                for (var opId in totalesPorOperacion) {
                    var opData = totalesPorOperacion[opId];
                    var esValida = Math.abs(opData.total - 100) < 0.01;
                    if (!esValida) todasValidas = false;

                    var claseColor = esValida ? 'ok' : (opData.total > 100 ? 'error' : 'warning');
                    var icono = esValida ? '✓' : (opData.total > 100 ? '✗' : '⚠');
                    html += '<span class="total-box ' + claseColor + '" style="font-size: 12px; padding: 4px 10px;">' +
                            icono + ' ' + opData.nombre + ': ' + opData.total.toFixed(2) + '%</span>';
                }
                listaValidacion.innerHTML = html;
            }

            var btnGuardar = document.getElementById('guardar-zonas');
            if (btnGuardar) {
                btnGuardar.disabled = !todasValidas;
                btnGuardar.title = todasValidas ? '' : 'Cada operacion debe sumar 100%';
            }

            return totalesPorOperacion;
        }

        // ========== ZONAS-MUNICIPIOS ==========
        function recalcularZonaMunicipios(zonaId) {
            var tabla = document.getElementById('tabla-zona-' + zonaId);
            if (!tabla) return 0;

            var ventaZona = parseFloat(tabla.dataset.zonaVenta) || 0;
            var inputs = tabla.querySelectorAll('.participacion-zona-mun');
            var totalParticipacion = 0;
            var totalVenta = 0;

            inputs.forEach(function(input) {
                var participacion = parseFloat(input.value) || 0;
                var venta = ventaZona * (participacion / 100);
                totalParticipacion += participacion;
                totalVenta += venta;

                var row = input.closest('tr');
                var ventaSpan = row.querySelector('.venta-valor');
                if (ventaSpan) {
                    ventaSpan.textContent = formatNumber(venta);
                }
            });

            var totalPartSpan = document.getElementById('total-participacion-zona-' + zonaId);
            if (totalPartSpan) totalPartSpan.textContent = totalParticipacion.toFixed(2);

            var totalVentaSpan = document.getElementById('total-venta-zona-' + zonaId);
            if (totalVentaSpan) totalVentaSpan.textContent = formatNumber(totalVenta);

            var totalBox = document.getElementById('total-participacion-zona-' + zonaId + '-box');
            updateTotalBoxClass(totalBox, totalParticipacion);

            // Actualizar boton de guardar de esta zona
            var btnGuardar = document.querySelector('.btn-guardar-zona[data-zona-id="' + zonaId + '"]');
            if (btnGuardar) {
                var esValido = Math.abs(totalParticipacion - 100) < 0.01;
                btnGuardar.disabled = !esValido;
                btnGuardar.title = esValido ? '' : 'La suma debe ser 100%' + getMensajeDiferencia(totalParticipacion);
            }

            actualizarTotalGeneralZonasMunicipios();
            return totalParticipacion;
        }

        function actualizarTotalGeneralZonasMunicipios() {
            var totalGeneral = 0;
            document.querySelectorAll('.participacion-zona-mun').forEach(function(input) {
                var zonaId = input.dataset.zonaId;
                var tabla = document.getElementById('tabla-zona-' + zonaId);
                if (tabla) {
                    var ventaZona = parseFloat(tabla.dataset.zonaVenta) || 0;
                    var participacion = parseFloat(input.value) || 0;
                    totalGeneral += ventaZona * (participacion / 100);
                }
            });
            var spanTotal = document.getElementById('total-general-zonas-municipios');
            if (spanTotal) {
                spanTotal.textContent = formatNumber(totalGeneral);
            }
        }

        // Event listeners para inputs
        document.querySelectorAll('.participacion-input').forEach(function(input) {
            input.oninput = function() {
                if (this.dataset.tipo === 'operacion') {
                    recalcularOperaciones();
                    recalcularZonasPorOperacion();
                } else if (this.dataset.tipo === 'zona') {
                    recalcularZonasPorOperacion();
                } else if (this.dataset.tipo === 'zona-municipio') {
                    recalcularZonaMunicipios(this.dataset.zonaId);
                }
            };
        });

        // Funcion para mostrar mensajes
        function mostrarMensaje(texto, tipo) {
            var container = document.getElementById('mensaje-container');
            container.innerHTML = '<div class="mensaje ' + tipo + '">' + texto + '</div>';
            setTimeout(function() {
                container.innerHTML = '';
            }, 5000);
        }

        // ========== GUARDAR OPERACIONES ==========
        var btnGuardarOperaciones = document.getElementById('guardar-operaciones');
        if (btnGuardarOperaciones) {
            btnGuardarOperaciones.onclick = function() {
                var items = [];
                var inputs = document.querySelectorAll('#tabla-operaciones .participacion-input');
                for (var i = 0; i < inputs.length; i++) {
                    items.push({
                        id: parseInt(inputs[i].dataset.id),
                        participacion: parseFloat(inputs[i].value) || 0
                    });
                }

                var btn = this;
                btn.disabled = true;
                btn.textContent = 'Guardando...';

                fetch(GUARDAR_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        tipo: 'operaciones',
                        items: items
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        return response.text().then(function(text) {
                            throw new Error('HTTP ' + response.status + ': ' + text.substring(0, 200));
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.success) {
                        mostrarMensaje('Distribucion por operaciones guardada correctamente.', 'success');
                        // Recargar manteniendo los parámetros de la URL
                        setTimeout(function() { window.location.href = window.location.href; }, 1500);
                    } else {
                        mostrarMensaje('Error: ' + data.error, 'error');
                        btn.disabled = false;
                        btn.textContent = 'Guardar Distribucion por Operaciones';
                    }
                })
                .catch(function(error) {
                    mostrarMensaje('Error al guardar: ' + error.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Guardar Distribucion por Operaciones';
                });
            };
        }

        // ========== GUARDAR ZONAS ==========
        var btnGuardarZonas = document.getElementById('guardar-zonas');
        if (btnGuardarZonas) {
            btnGuardarZonas.onclick = function() {
                var items = [];
                document.querySelectorAll('#tabla-zonas .participacion-input').forEach(function(input) {
                    items.push({
                        id: parseInt(input.dataset.id),
                        participacion: parseFloat(input.value) || 0
                    });
                });

                var btn = this;
                btn.disabled = true;
                btn.textContent = 'Guardando...';

                fetch(GUARDAR_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        tipo: 'zonas',
                        items: items
                    })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        mostrarMensaje('Distribucion de zonas guardada correctamente.', 'success');
                        setTimeout(function() { window.location.href = window.location.href; }, 1500);
                    } else {
                        mostrarMensaje('Error: ' + data.error, 'error');
                        btn.disabled = false;
                        btn.textContent = 'Guardar Distribucion de Zonas';
                    }
                })
                .catch(function(error) {
                    mostrarMensaje('Error al guardar: ' + error, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Guardar Distribucion de Zonas';
                });
            };
        }

        // ========== GUARDAR ZONAS-MUNICIPIOS ==========
        document.querySelectorAll('.btn-guardar-zona').forEach(function(btn) {
            btn.onclick = function() {
                var zonaId = this.dataset.zonaId;
                var tabla = document.getElementById('tabla-zona-' + zonaId);
                if (!tabla) return;

                var items = [];
                tabla.querySelectorAll('.participacion-zona-mun').forEach(function(input) {
                    items.push({
                        id: parseInt(input.dataset.id),
                        participacion: parseFloat(input.value) || 0
                    });
                });

                var originalText = this.textContent;
                var btnEl = this;
                btnEl.disabled = true;
                btnEl.textContent = 'Guardando...';

                fetch(GUARDAR_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        tipo: 'zonas_municipios',
                        zona_id: parseInt(zonaId),
                        items: items
                    })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        mostrarMensaje('Distribucion guardada correctamente.', 'success');
                    } else {
                        mostrarMensaje('Error: ' + data.error, 'error');
                    }
                    btnEl.disabled = false;
                    btnEl.textContent = originalText;
                })
                .catch(function(error) {
                    mostrarMensaje('Error al guardar: ' + error, 'error');
                    btnEl.disabled = false;
                    btnEl.textContent = originalText;
                });
            };
        });

        // Calculos iniciales
        recalcularOperaciones();
        recalcularZonasPorOperacion();
        document.querySelectorAll('[id^="tabla-zona-"]').forEach(function(tabla) {
            var zonaId = tabla.dataset.zonaId;
            if (zonaId) {
                recalcularZonaMunicipios(zonaId);
            }
        });

        console.log('Distribucion de Ventas JS cargado correctamente');
    }
})();
</script>
{% endblock %}
